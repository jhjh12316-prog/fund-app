<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>基金自选估值</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC";
  background: #111;
  color: #eee;
  margin: 0;
  padding: 14px;
}

.night .card { opacity: 0.7; }

.card {
  background: #1c1c1e;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
}

.title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 6px;
}

.up { color: #ff4d4f; }
.down { color: #4cd964; }

.time {
  font-size: 12px;
  opacity: 0.7;
  margin-top: 6px;
}

.input-box {
  display: flex;
  gap: 8px;
}

input {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
  font-size: 15px;
}

button {
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  background: #3a3a3c;
  color: #fff;
  font-size: 13px;
}

.actions {
  margin-top: 8px;
  display: flex;
  gap: 8px;
}
</style>
</head>

<body>

<div class="card">
  <div class="input-box">
    <input id="fundInput" placeholder="输入6位基金代码">
    <button onclick="addFund()">添加</button>
    <button onclick="refreshAll()">刷新</button>
  </div>
</div>

<div id="fundList"></div>

<script>
/* ========= 数据 ========= */
let fundCodes = JSON.parse(localStorage.getItem("fundCodes")) || ["161725"];
const fundData = {};
const loadTimer = {};

/* ========= 夜盘 ========= */
(() => {
  const h = new Date().getHours();
  if (h < 9 || h > 15) document.body.classList.add("night");
})();

/* ========= 添加 ========= */
function addFund() {
  const input = document.getElementById("fundInput");
  const code = input.value.trim();

  if (!/^\d{6}$/.test(code)) {
    alert("请输入6位基金代码");
    return;
  }
  if (fundCodes.includes(code)) {
    alert("已经加过了");
    return;
  }

  fundCodes.push(code);
  localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
  input.value = "";

  render();
  loadFund(code);
}

/* ========= 删除 ========= */
function removeFund(code) {
  fundCodes = fundCodes.filter(c => c !== code);
  localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
  delete fundData[code];
  render();
}

/* ========= 排序 ========= */
function moveFund(code, dir) {
  const i = fundCodes.indexOf(code);
  const j = i + dir;
  if (j < 0 || j >= fundCodes.length) return;
  [fundCodes[i], fundCodes[j]] = [fundCodes[j], fundCodes[i]];
  localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
  render();
}

/* ========= 拉数据 ========= */
function loadFund(code) {
  const old = document.getElementById("script_" + code);
  if (old) old.remove();

  fundData[code] = { status: "loading" };
  render();

  const s = document.createElement("script");
  s.id = "script_" + code;
  s.src = `https://fundgz.1234567.com.cn/js/${code}.js`;
  document.body.appendChild(s);

  // 超时保护
  clearTimeout(loadTimer[code]);
  loadTimer[code] = setTimeout(() => {
    if (fundData[code]?.status === "loading") {
      fundData[code] = { status: "unsupported" };
      render();
    }
  }, 5000);
}

/* ========= JSONP ========= */
function jsonpgz(data) {
  fundData[data.fundcode] = {
    status: "ok",
    ...data
  };
  render();
}

/* ========= 渲染 ========= */
function render() {
  const box = document.getElementById("fundList");
  box.innerHTML = "";

  fundCodes.forEach(code => {
    const d = fundData[code];

    let content = `<div style="opacity:.6">数据加载中…</div>`;

    if (d?.status === "ok") {
      const cls = d.gszzl >= 0 ? "up" : "down";
      content = `
        <div>估值：${d.gsz}</div>
        <div class="${cls}">涨跌：${d.gszzl}%</div>
        <div class="time">${d.gztime}</div>`;
    }

    if (d?.status === "unsupported") {
      content = `<div style="color:#ff9f0a">该基金暂不支持实时估值</div>`;
    }

    box.innerHTML += `
      <div class="card">
        <div class="title">${d?.name || "基金 " + code}</div>
        ${content}
        <div class="actions">
          <button onclick="moveFund('${code}',-1)">↑</button>
          <button onclick="moveFund('${code}',1)">↓</button>
          <button onclick="removeFund('${code}')">删除</button>
        </div>
      </div>`;
  });
}

/* ========= 刷新 ========= */
function refreshAll() {
  fundCodes.forEach(loadFund);
}

render();
refreshAll();
setInterval(refreshAll, 30000);
</script>

</body>
</html>
