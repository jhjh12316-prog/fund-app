<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>基金自选估值（多源）</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC";
  background: linear-gradient(180deg,#0f1115,#1c1c22);
  color: #eee;
  margin: 0;
  padding: 14px;
}

.card {
  background: #1e1e28;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transition: transform 0.15s;
  touch-action: pan-y;
  position: relative;
}

.card.dragging { opacity:0.7; transform:scale(1.03); }

.night .card { opacity: 0.8; }

.title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}

.up { color: #ff4d4f; font-weight:600; }
.down { color: #4cd964; font-weight:600; }

.time, .badge {
  font-size: 12px;
  opacity: 0.8;
  margin-top: 4px;
}

.input-box, .top-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

input {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-size: 15px;
  background: #2a2a35;
  color: #fff;
}

button {
  padding: 10px 16px;
  border-radius: 12px;
  border: none;
  background: #3a3a4a;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.15s;
}

button:hover { background: #505060; }

.actions {
  margin-top: 10px;
  display: flex;
  gap: 6px;
}

.badge { color: #ff9f0a; font-weight: 600; }

.deleteBtn {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background:#ff4d4f;
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  display:none;
}

.card.showDelete .deleteBtn { display:block; }

</style>
</head>
<body>

<div class="card">
  <div class="input-box">
    <input id="fundInput" placeholder="输入6位基金代码">
    <button onclick="addFund()">添加</button>
    <button onclick="refreshAll()">刷新</button>
  </div>
  <div class="top-actions">
    <button onclick="toggleUnsupported()">显示 / 隐藏 无估值基金</button>
  </div>
</div>

<div id="fundList"></div>

<script>
let fundCodes = JSON.parse(localStorage.getItem("fundCodes")) || ["161725"];
const fundData = {};
const loadTimer = {};
let showUnsupported = false;

const now = new Date();
const hour = now.getHours();
const isTrading = hour >= 9 && hour < 15;
if (!isTrading) document.body.classList.add("night");

/* ===== 添加基金 ===== */
function addFund() {
  const input = document.getElementById("fundInput");
  const code = input.value.trim();
  if (!/^\d{6}$/.test(code)) { alert("请输入6位基金代码"); return; }
  if (fundCodes.includes(code)) { alert("已经加过了"); return; }
  fundCodes.push(code);
  localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
  input.value = "";
  render();
  loadFund(code);
}

/* ===== 删除 ===== */
function removeFund(code) {
  fundCodes = fundCodes.filter(c => c !== code);
  localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
  delete fundData[code];
  render();
}

/* ===== 排序 ===== */
function moveFund(code, dir) {
  const i = fundCodes.indexOf(code), j=i+dir;
  if(j<0||j>=fundCodes.length) return;
  [fundCodes[i], fundCodes[j]]=[fundCodes[j], fundCodes[i]];
  localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
  render();
}

/* ===== 显示隐藏无估值 ===== */
function toggleUnsupported(){ showUnsupported=!showUnsupported; render(); }

/* ===== 加载基金 ===== */
function loadFund(code){
  const old = document.getElementById("script_"+code);
  if(old) old.remove();
  fundData[code]={status:"loading"};
  render();

  // 1. 优先东财
  const s=document.createElement("script");
  s.id="script_"+code;
  s.src=`https://fundgz.1234567.com.cn/js/${code}.js`;
  document.body.appendChild(s);

  clearTimeout(loadTimer[code]);
  loadTimer[code]=setTimeout(()=>{
    if(fundData[code]?.status==="loading"){
      // 2. 备用新浪接口
      fetch(`https://hq.sinajs.cn/list=f_${code}`).then(r=>r.text())
      .then(txt=>{
        const match=txt.match(/"([^"]+)"/);
        if(match){
          const arr=match[1].split(",");
          if(arr.length>3){
            fundData[code]={status:"ok", name:arr[0], dwjz:arr[3], gszzl:parseFloat(arr[2]), gztime:arr[1]};
          } else fundData[code]={status:"unsupported"};
        } else fundData[code]={status:"unsupported"};
        render();
      }).catch(()=>{fundData[code]={status:"unsupported"}; render();});
    }
  },5000);
}

/* ===== JSONP回调 ===== */
function jsonpgz(data){
  fundData[data.fundcode]={status:"ok", ...data};
  render();
}

/* ===== 渲染列表 ===== */
function render(){
  const box=document.getElementById("fundList");
  box.innerHTML="";
  fundCodes.forEach(code=>{
    const d=fundData[code];
    if(d?.status==="unsupported"&&!showUnsupported) return;

    let content=`<div style="opacity:.6">数据加载中…</div>`;
    if(d?.status==="ok"){
      const cls=d.gszzl>=0?"up":"down";
      if(isTrading){
        content=`<div>估值：${d.gsz||d.dwjz}</div>
                 <div class="${cls}">↑${d.gszzl}%</div>
                 <div class="time">${d.gztime||""}</div>`;
      }else{
        content=`<div class="badge">盘后参考</div>
                 <div>单位净值：${d.dwjz}</div>
                 <div class="${cls}">昨日涨跌：${d.gszzl}%</div>`;
      }
    }
    if(d?.status==="unsupported") content=`<div class="badge">该基金无实时估值</div>`;

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="title">${d?.name||"基金 "+code}</div>
      ${content}
      <button class="deleteBtn" onclick="removeFund('${code}')">删除</button>`;
    box.appendChild(card);

    /* ===== 拖拽排序 ===== */
    let startY, currentY, dragging=false, placeholder;
    card.addEventListener("touchstart", e=>{
      startY=e.touches[0].clientY;
    });
    card.addEventListener("touchmove", e=>{
      currentY=e.touches[0].clientY;
      const deltaY=currentY-startY;
      if(Math.abs(deltaY)>10 && !dragging){
        dragging=true;
        card.classList.add("dragging");
        placeholder=document.createElement("div");
        placeholder.style.height=card.offsetHeight+"px";
        box.insertBefore(placeholder, card.nextSibling);
      }
      if(dragging) card.style.transform=`translateY(${deltaY}px)`;
    });
    card.addEventListener("touchend", e=>{
      if(dragging){
        card.style.transform="";
        card.classList.remove("dragging");
        box.insertBefore(card, placeholder);
        placeholder.remove();
        dragging=false;
        // 更新顺序
        const newOrder=[];
        box.querySelectorAll(".card").forEach(c=>{
          const title=c.querySelector(".title").innerText;
          const match=title.match(/\d{6}/);
          if(match) newOrder.push(match[0]);
          else {
            // 尝试名称对应
            fundCodes.forEach(f=>{if(fundData[f]?.name===title)newOrder.push(f);});
          }
        });
        if(newOrder.length===fundCodes.length){
          fundCodes=newOrder;
          localStorage.setItem("fundCodes", JSON.stringify(fundCodes));
        }
      }
    });

    /* ===== 左滑删除 ===== */
    let startX;
    card.addEventListener("touchstart", e=>{ startX=e.touches[0].clientX; card.classList.remove("showDelete"); });
    card.addEventListener("touchmove", e=>{
      let moveX=e.touches[0].clientX-startX;
      if(moveX<-50) card.classList.add("showDelete");
      else if(moveX>20) card.classList.remove("showDelete");
    });
  });
}

/* ===== 刷新 ===== */
function refreshAll(){ fundCodes.forEach(loadFund); }

render();
refreshAll();
setInterval(refreshAll,30000);
</script>

</body>
</html>
