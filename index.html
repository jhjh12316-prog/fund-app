<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>基金估值</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#0f0f14;color:#eee;font-family:system-ui}
.wrap{max-width:420px;margin:auto;padding:16px}
.card{background:linear-gradient(135deg,#6b7cff,#8e5cff);
  border-radius:14px;padding:16px;margin-bottom:14px}
.box{background:#1b1b22;border-radius:12px;padding:14px;margin-bottom:14px}
.item{display:flex;justify-content:space-between;
  padding:10px 0;border-bottom:1px solid #333}
.item:last-child{border:none}
.red{color:#ff6b6b}
.green{color:#4cffb0}
input,button{background:#2a2a33;color:#eee;
  border:none;border-radius:6px;padding:6px}
input{width:90px}
button{margin-left:6px}
small{color:#aaa}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <div>总资产</div>
  <h2 id="total">--</h2>
  <small>当日盈亏：<span id="today">--</span></small>
</div>

<div class="box">
  <h3>我的持仓</h3>
  <div id="list"></div>

  <div style="margin-top:10px">
    <input id="code" placeholder="代码/名称">
    <input id="money" placeholder="金额">
    <button onclick="add()">添加</button>
    <button onclick="exportCSV()">导出</button>
  </div>

  <div id="searchResult" style="margin-top:10px"></div>
</div>

<div class="box">
  <h3>夜盘参考</h3>
  <div id="night">加载中…</div>
</div>

</div>

<script>
let funds = JSON.parse(localStorage.getItem("funds")||"[]")
function save(){localStorage.setItem("funds",JSON.stringify(funds))}

function fetchChina(code){
  return new Promise((resolve,reject)=>{
    const cb="cb"+Date.now()
    window[cb]=data=>{
      delete window[cb]
      document.body.removeChild(script)
      resolve({name:data.name,change:+data.gszzl})
    }
    const script=document.createElement("script")
    script.src=`https://fundgz.1234567.com.cn/js/${code}.js?callback=${cb}`
    script.onerror=()=>reject()
    document.body.appendChild(script)
  })
}

async function fetchGlobal(s){
  let r=await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${s}`)
  let j=await r.json()
  let m=j.chart.result[0].meta
  return {
    name:s,
    change:(m.regularMarketPrice-m.previousClose)/m.previousClose*100
  }
}

async function render(){
  let total=0,today=0
  list.innerHTML=""
  for(let f of funds){
    try{
      let d=/^\d+$/.test(f.code)
        ?await fetchChina(f.code)
        :await fetchGlobal(f.code)

      let day=f.money*d.change/100
      total+=f.money
      today+=day

      let div=document.createElement("div")
      div.className="item"
      div.innerHTML=`
        <div>${d.name}<br><small>${f.money}</small></div>
        <div class="${day>=0?'red':'green'}">
          ${(day>=0?'+':'')+day.toFixed(2)}
        </div>`
      list.appendChild(div)
    }catch(e){}
  }
  document.getElementById("total").innerText=(total+today).toFixed(2)
  document.getElementById("today").innerText=
    (today>=0?'+':'')+today.toFixed(2)
}

function add(){
  let c=code.value.trim()
  let m=+money.value
  if(!c||!m)return
  funds.push({code:c,money:m})
  save()
  render()
}

async function night(){
  try{
    let dxy=await fetchGlobal("DX-Y.NYB")
    let gc=await fetchGlobal("GC=F")
    night.innerHTML=
      `美元指数 ${dxy.change.toFixed(2)}%<br>
       黄金 ${gc.change.toFixed(2)}%<br><br>`+
      (dxy.change<0&&gc.change>0
        ?"资源偏多"
        :"偏防御")
  }catch{
    night.innerText="夜盘数据不可用"
  }
}

function exportCSV(){
  let csv="代码,金额\n"+funds.map(f=>`${f.code},${f.money}`).join("\n")
  let a=document.createElement("a")
  a.href=URL.createObjectURL(new Blob([csv]))
  a.download="funds.csv"
  a.click()
}

render()
night()
setInterval(render,30000)
</script>
</body>
</html>
