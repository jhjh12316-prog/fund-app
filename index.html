<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>基金实时估值</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#0f0f14;color:#eee;font-family:system-ui}
.wrap{max-width:420px;margin:auto;padding:16px}
.card{
  background:linear-gradient(135deg,#6b7cff,#8e5cff);
  border-radius:14px;padding:16px;margin-bottom:14px
}
.card h1{margin:0;font-size:22px}
.row{display:flex;justify-content:space-between;margin-top:10px}
.box{background:#1b1b22;border-radius:12px;padding:14px}
.item{display:flex;justify-content:space-between;align-items:center;
  padding:10px 0;border-bottom:1px solid #333}
.item:last-child{border:none}
.red{color:#ff6b6b}
.green{color:#4cffb0}
input,button{
  background:#2a2a33;color:#eee;border:none;border-radius:6px;padding:6px
}
input{width:70px}
button{margin-left:6px}
small{color:#aaa}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <h1>总资产</h1>
  <div class="row">
    <div>
      <small>资产合计</small>
      <div id="total">--</div>
    </div>
    <div>
      <small>当日盈亏</small>
      <div id="today">--</div>
    </div>
  </div>
</div>

<div class="box">
  <h3>我的持仓</h3>
  <div id="list"></div>

  <div style="margin-top:10px">
    <input id="code" placeholder="代码">
    <input id="money" placeholder="金额">
    <button onclick="add()">添加</button>
    <button onclick="exportCSV()">导出</button>
  </div>
</div>

<div class="box" style="margin-top:14px">
  <h3>夜盘参考</h3>
  <div id="night">加载中…</div>
</div>

</div>

<script>
let funds = JSON.parse(localStorage.getItem("funds")||"[]")

function save(){localStorage.setItem("funds",JSON.stringify(funds))}

async function china(code){
  let r = await fetch(`https://fundgz.1234567.com.cn/js/${code}.js`)
  let t = await r.text()
  let j = eval(t.replace("jsonpgz(","").replace(");",""))
  return {name:j.name,price:+j.gsz,change:+j.gszzl}
}

async function global(s){
  let r = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${s}`)
  let j = await r.json()
  let m=j.chart.result[0].meta
  return {
    name:s,
    price:m.regularMarketPrice,
    change:(m.regularMarketPrice-m.previousClose)/m.previousClose*100
  }
}

async function render(){
  let total=0,today=0
  let box=document.getElementById("list")
  box.innerHTML=""
  for(let f of funds){
    let d = f.type==="china"?await china(f.code):await global(f.code)
    let day = f.money*d.change/100
    total+=f.money
    today+=day
    let div=document.createElement("div")
    div.className="item"
    div.innerHTML=`
      <div>
        ${d.name}<br><small>${f.money}</small>
      </div>
      <div class="${day>=0?'red':'green'}">
        ${(day>=0?'+':'')+day.toFixed(2)}
      </div>`
    box.appendChild(div)
  }
  total+=today
  document.getElementById("total").innerText=total.toFixed(2)
  document.getElementById("today").innerText=
    (today>=0?'+':'')+today.toFixed(2)
}

function add(){
  let c=code.value.trim()
  let m=+money.value
  if(!c||!m)return
  funds.push({code:c,money:m,type:/^\d+$/.test(c)?"china":"global"})
  save();render()
}

async function night(){
  let dxy=await global("DX-Y.NYB")
  let nq=await global("NQ=F")
  let gc=await global("GC=F")
  let txt=`美元指数 ${dxy.change.toFixed(2)}%<br>
  纳指期货 ${nq.change.toFixed(2)}%<br>
  黄金期货 ${gc.change.toFixed(2)}%<br><br>
  ${
    dxy.change<0&&gc.change>0
    ?"资源偏多，风险偏好上升"
    :"偏防御，注意回撤"
  }`
  nightBox.innerHTML=txt
}

function exportCSV(){
  let rows=["名称,代码,金额"]
  funds.forEach(f=>rows.push(`${f.code},${f.code},${f.money}`))
  let blob=new Blob([rows.join("\n")],{type:"text/csv"})
  let a=document.createElement("a")
  a.href=URL.createObjectURL(blob)
  a.download="funds.csv"
  a.click()
}

render()
night()
setInterval(render,30000)
</script>
</body>
</html>
